<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>트랜잭션과 락 이해하기 : 데이터베이스 관리의 핵심, 동시성과 무결성의 균형잡기 &#183; Smmin21's Blog</title>
<meta name=title content="트랜잭션과 락 이해하기 : 데이터베이스 관리의 핵심, 동시성과 무결성의 균형잡기 &#183; Smmin21's Blog"><meta name=description content="All the shortcodes available in Blowfish."><meta name=keywords content="Transaction,Lock,DB,JPA,"><link rel=canonical href=https://smmin21.github.io/posts/transaction_lock/><link type=text/css rel=stylesheet href=/css/main.bundle.min.2b4bebea7a930667b464f1045e311cebccfa295fd43dfb249a31d7b86f035a86b7e383c54d28d95282e61e6d9f515b6e2fdf347153eda013eb3d715e31ff72c6.css integrity="sha512-K0vr6nqTBme0ZPEEXjEc68z6KV/UPfskmjHXuG8DWoa344PFTSjZUoLmHm2fUVtuL980cVPtoBPrPXFeMf9yxg=="><script type=text/javascript src=/js/appearance.min.303ad233e0be50d5627470bb94d41e48da77656d3b828057ba8c2626a420b99c0be45cc4a51f16af4d7b2e0b2b277087569a7af3cf37d071cf618a1870622e23.js integrity="sha512-MDrSM+C+UNVidHC7lNQeSNp3ZW07goBXuowmJqQguZwL5FzEpR8Wr017LgsrJ3CHVpp688830HHPYYoYcGIuIw=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.1271c22a557a15f10b5d38d2c87e49503604cfeffebadc1e7c267934e4b9f3ba1b74d81371219f9681dab2141482fc4ed2a8b462b179f0ef43a5f76d0575e85b.js integrity="sha512-EnHCKlV6FfELXTjSyH5JUDYEz+/+utwefCZ5NOS587obdNgTcSGfloHashQUgvxO0qi0YrF58O9DpfdtBXXoWw==" data-copy data-copied></script><script src=/js/zoom.min.js></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="트랜잭션과 락 이해하기 : 데이터베이스 관리의 핵심, 동시성과 무결성의 균형잡기"><meta property="og:description" content="All the shortcodes available in Blowfish."><meta property="og:type" content="article"><meta property="og:url" content="https://smmin21.github.io/posts/transaction_lock/"><meta property="og:image" content="https://smmin21.github.io/posts/transaction_lock/featured.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-24T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-24T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://smmin21.github.io/posts/transaction_lock/featured.jpg"><meta name=twitter:title content="트랜잭션과 락 이해하기 : 데이터베이스 관리의 핵심, 동시성과 무결성의 균형잡기"><meta name=twitter:description content="All the shortcodes available in Blowfish."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"트랜잭션과 락 이해하기 : 데이터베이스 관리의 핵심, 동시성과 무결성의 균형잡기","headline":"트랜잭션과 락 이해하기 : 데이터베이스 관리의 핵심, 동시성과 무결성의 균형잡기","description":"All the shortcodes available in Blowfish.","abstract":"한 유명 레스토랑에서 새로운 예약 시스템을 도입하여 매일 오후 5시마다 다음 날 예약 손님 50명을 받기로 결정했다.","inLanguage":"en","url":"https:\/\/smmin21.github.io\/posts\/transaction_lock\/","author":{"@type":"Person","name":"Hi, I\u0027m Sumin Lee!"},"copyrightYear":"2024","dateCreated":"2024-01-24T00:00:00\u002b00:00","datePublished":"2024-01-24T00:00:00\u002b00:00","dateModified":"2024-01-24T00:00:00\u002b00:00","keywords":["Transaction","Lock","DB","JPA"],"mainEntityOfPage":"true","wordCount":"1915"}]</script><meta name=author content="Hi, I'm Sumin Lee!"><link href=mailto:nstern999@gmail.com rel=me><link href=https://github.com/smmin21 rel=me><link href=https://www.linkedin.com/in/sumin-lee-a790b1257 rel=me><script src=/lib/jquery/jquery.slim.min.js integrity></script><meta name=theme-color><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js></script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js></script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js></script><script>const firebaseConfig={apiKey:"AIzaSyCM9wpKO3ghjmu29W4kpiSiNdSqu7IMwCg",authDomain:"AIzaSyCM9wpKO3ghjmu29W4kpiSiNdSqu7IMwCg",projectId:"my-blog-753d5",storageBucket:"my-blog-753d5.appspot.com",messagingSenderId:"128495073553",appId:"1:128495073553:web:cf8c8bdb86e08654dc74b0",measurementId:"G-4Y6YG1LJ4W"};var app=firebase.initializeApp(firebaseConfig),db=firebase.firestore(),auth=firebase.auth()</script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3"><div><a href=/ class=flex><span class=sr-only>Smmin21&rsquo;s Blog</span>
<img src=/img/logo.png width=25 height=23 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="Smmin21's Blog"></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Smmin21&rsquo;s Blog</a></nav><nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12"><a href=/posts/ class="flex items-center"><p class="text-base font-medium text-gray-500 hover:text-gray-900" title=Posts>Blog</p></a><a href=/tags/ class="flex items-center"><p class="text-base font-medium text-gray-500 hover:text-gray-900" title=Tags>Tags</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400 h-12" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="ltr:mr-14 rtl:ml-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"><button id=appearance-switcher aria-label="Dark mode switcher" type=button><div class="flex items-center justify-center h-12 dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden h-12 dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center space-x-5 md:ml-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button style=margin-right:5px><div class="flex items-center justify-center h-12 dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden h-12 dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 -mr-2 md:hidden"><label id=menu-button for=menu-controller class=block><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/posts/ class="flex items-center"><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title=Posts>Blog</p></a></li><li class=mt-1><a href=/tags/ class="flex items-center"><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title=Tags>Tags</p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div id=hero class="h-[150px] md:h-[200px]"></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom" style=background-image:url(/posts/transaction_lock/featured_hu0a9fd9e52b393d62ba9e4eb1ecd4bd53_324990_1200x0_resize_q75_box.jpg)><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("background-blur");n.style.opacity=t/300})</script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">트랜잭션과 락 이해하기 : 데이터베이스 관리의 핵심, 동시성과 무결성의 균형잡기</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div style=cursor:default class="flex flex-row flex-wrap items-center"><time datetime="2024-01-24 00:00:00 +0000 UTC">24 January 2024</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">9 mins</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=views_posts/transaction_lock/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=views>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg>
</span></span></span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=likes_posts/transaction_lock/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=likes>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
</span></span></span><span class="px-2 text-primary-500">&#183;</span><span>
<button id=button_likes class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400" onclick=process_article()>
<span id=button_likes_heart style=display:none class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
</span></span><span id=button_likes_emtpty_heart class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M244 84l11.1 12 12-11.98C300.6 51.37 347 36.51 392.6 44.1 461.5 55.58 512 115.2 512 185.1V190.9c0 41.5-17.2 81.2-47.6 109.5L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9S235.8 476.1 228.3 469.1L47.59 300.4C17.23 272.1.0 232.4.0 190.9V185.1c0-69.9 50.52-129.52 119.4-141 44.7-7.59 92 7.27 124.6 39.9C243.1 84 244 84.01 244 84zm11.1 79.9-45-46.8c-21.7-20.82-52.5-30.7-82.8-25.66C81.55 99.07 48 138.7 48 185.1V190.9c0 28.2 11.71 55.2 32.34 74.4L256 429.3l175.7-164c20.6-19.2 32.3-46.2 32.3-74.4V185.1c0-46.4-33.6-86.03-79.3-93.66C354.4 86.4 323.6 96.28 301.9 117.1l-46.8 46.8z"/></svg>
</span></span><span id=button_likes_text>&nbsp;Like</span>
</button>
</span><span class="px-2 text-primary-500">&#183;</span>
<script type=text/javascript src=/js/zen-mode.min.16f2e42a0014d476212e14c056b26b69bc85cb5de15352a5e3a1a0be498055dc1bf0926cef44baef1cc7fa2dfc5de0052892645cd3766598065f47b15c4bd44d.js integrity="sha512-FvLkKgAU1HYhLhTAVrJrabyFy13hU1Kl46GgvkmAVdwb8JJs70S67xzH+i38XeAFKJJkXNN2ZZgGX0exXEvUTQ=="></script><span class=mb-[2px]><span id=zen-mode-button class="text-lg hover:text-primary-500" title="Enable zen mode" data-title-i18n-disable="Enable zen mode" data-title-i18n-enable="Disable zen mode"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="50" height="50"><path fill="currentcolor" d="M12.980469 4C9.1204688 4 5.9804688 7.14 5.9804688 11L6 26H9.9804688V11c0-1.65 1.3400002-3 3.0000002-3H40.019531c1.66.0 3 1.35 3 3V39c0 1.65-1.34 3-3 3H29c0 1.54-.579062 2.94-1.539062 4H40.019531c3.86.0 7-3.14 7-7V11c0-3.86-3.14-7-7-7H12.980469zM7 28c-2.206.0-4 1.794-4 4V42c0 2.206 1.794 4 4 4H23c2.206.0 4-1.794 4-4V32c0-2.206-1.794-4-4-4H7zm0 4H23L23.001953 42H7V32z"/></svg></span></span></span></span></div><div style=cursor:pointer class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/transaction/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Transaction
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/lock/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Lock
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/db/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">DB
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/jpa/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">JPA</span></span></span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open class="toc-right mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#1-트랜잭션transaction이란-무엇일까>1. 트랜잭션(Transaction)이란 무엇일까?</a><ul><li><a href=#11-트랜잭션은-구체적으로-어떻게-동작하는-걸까>1.1. 트랜잭션은 구체적으로 어떻게 동작하는 걸까?</a></li><li><a href=#12-acid-특성>1.2. ACID 특성</a></li></ul></li><li><a href=#2-더-높은-격리-수준이-필요하다면-락lock을-사용하자>2. 더 높은 격리 수준이 필요하다면, 락(Lock)을 사용하자</a><ul><li><a href=#21-낙관적-락optimistic-lock>2.1. 낙관적 락(Optimistic Lock)</a></li><li><a href=#22-비관적-락pessimistic-lock>2.2. 비관적 락(Pessimistic Lock)</a></li></ul></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#1-트랜잭션transaction이란-무엇일까>1. 트랜잭션(Transaction)이란 무엇일까?</a><ul><li><a href=#11-트랜잭션은-구체적으로-어떻게-동작하는-걸까>1.1. 트랜잭션은 구체적으로 어떻게 동작하는 걸까?</a></li><li><a href=#12-acid-특성>1.2. ACID 특성</a></li></ul></li><li><a href=#2-더-높은-격리-수준이-필요하다면-락lock을-사용하자>2. 더 높은 격리 수준이 필요하다면, 락(Lock)을 사용하자</a><ul><li><a href=#21-낙관적-락optimistic-lock>2.1. 낙관적 락(Optimistic Lock)</a></li><li><a href=#22-비관적-락pessimistic-lock>2.2. 비관적 락(Pessimistic Lock)</a></li></ul></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p><figure><img class="my-0 rounded-md" srcset="/posts/transaction_lock/image/intro_hud62a5f22aa920c03160085121a2ad1fc_108811_330x0_resize_q75_box.jpeg 330w,
/posts/transaction_lock/image/intro_hud62a5f22aa920c03160085121a2ad1fc_108811_660x0_resize_q75_box.jpeg 660w,
/posts/transaction_lock/image/intro_hud62a5f22aa920c03160085121a2ad1fc_108811_1024x0_resize_q75_box.jpeg 1024w,
/posts/transaction_lock/image/intro_hud62a5f22aa920c03160085121a2ad1fc_108811_1320x0_resize_q75_box.jpeg 2x" src=/posts/transaction_lock/image/intro_hud62a5f22aa920c03160085121a2ad1fc_108811_660x0_resize_q75_box.jpeg alt="My data is wrong. We must go back"></figure></p></br><p>한 유명 레스토랑에서 새로운 예약 시스템을 도입하여 매일 오후 5시마다 다음 날 예약 손님 50명을 받기로 결정했다. 해당 서비스의 도입 첫날, 사람들은 마치 인기 가수의 콘서트 티켓팅을 하는 것처럼 5시만을 기다리고 있다가 동시에 예약 신청을 했고 순식간에 예약이 마감되었다. 그렇게 새로 도입한 시스템은 안정적으로 작동된 줄 알았지만, 가게 주인이 예약을 성공한 손님들의 리스트를 확인해 보니 처음 계획한 50명을 넘어서 68명의 손님이 예약되어 있었다! 가게에는 앉을 수 있는 자리가 한정되어 있고 준비된 재료도 제한되어 있기 때문에 어쩔 수 없이 가게 주인은 몇몇 손님들께 양해를 구하며 강제로 예약을 취소할 수밖에 없었다.</p><p>이건 데이터베이스 시스템의 무결성을 유지하는 것이 얼마나 중요한지를 말하기 위해 각색한 이야기이다. 예약 신청 요청이 들어오면 설정해 놓은 정원에서 인원수를 정확히 차감하여 현재 남은 자릿수를 계산해야 한다. 하지만 데이터베이스 값을 읽고 쓰는 과정에서 무결성과 동시성을 제대로 제어하지 못하면 위와 같은 문제 상황이 발생할 수 있다. 만약 피해 규모가 더 크고 사안이 더 심각한 실제 비즈니스 상황이었다면, 기업의 신뢰성은 물론이고 손님들의 만족도 또한 크게 하락하여 큰 문제로 이어질 수도 있었을 것이다. 이러한 끔찍한 상황을 피하기위해, 우리는 데이터베이스 시스템에서 트랜잭션과 락에 대해 제대로 이해하고 사용할 줄 알아야 한다. 그럼, 본격적으로 트랜잭션에 대해 먼저 알아보도록 하자.</p></br><h2 class="relative group">1. 트랜잭션(Transaction)이란 무엇일까?<div id=1-트랜잭션transaction이란-무엇일까 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1-%ed%8a%b8%eb%9e%9c%ec%9e%ad%ec%85%98transaction%ec%9d%b4%eb%9e%80-%eb%ac%b4%ec%97%87%ec%9d%bc%ea%b9%8c aria-label=Anchor>#</a></span></h2><p>쇼핑몰 사이트에서 물건을 하나 주문할 때 내부에서 어떤 로직이 실행되고 데이터베이스에 정보가 저장되는지를 생각해 보자. 해당 상품에는 정해져 있는 한정된 재고량이 있을 것이고, 소비자의 주문 요청이 들어오면 요청 수량만큼 차감되어 값이 갱신되고 새로운 주문 접수가 이루어질 것이다. 그러면 백엔드 개발자 입장에서는 주문 요청이 들어왔을 때,</p><ol><li>주문 요청 들어온 수만큼 상품 재고 차감 후 DB에 값 업데이트</li><li>새로운 주문 정보 저장</li></ol><p>이 두 가지 일을 처리하게 된다. 이와 같이 데이터베이스의 상태를 변화시키는 작업에는 일련의 연산들이 하나의 작업 단위로 묶여 처리되곤 하는데, 이 논리적 작업 단위를 <strong>트랜잭션</strong>이라 한다.</p><p>이 정도의 설명으로 트랜잭션의 간단한 개념 정도는 파악할 수 있다. 하지만 막상 프로젝트를 진행하려고 하면 &lsquo;그래서 트랜잭션이 실제 코드상에선 어떻게 동작한다는 건데?&rsquo;, &lsquo;어느 범위까지 트랜잭션을 통해 관리가 된다는 거지?&rsquo; 등과 같은 의문이 생긴다. 제대로 이해하지 않은 채 무작정 <code>@Transactional</code>만 붙이고 코드를 작성하다 보면, 문제가 생겨도 원인을 찾지 못하고 오랜 시간을 헤매게 될 수 있다. 그래서 스프링 컨테이너에서의 트랜잭션을 조금 더 자세하게 알아보려고 한다.</p></br><h3 class="relative group">1.1. 트랜잭션은 구체적으로 어떻게 동작하는 걸까?<div id=11-트랜잭션은-구체적으로-어떻게-동작하는-걸까 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#11-%ed%8a%b8%eb%9e%9c%ec%9e%ad%ec%85%98%ec%9d%80-%ea%b5%ac%ec%b2%b4%ec%a0%81%ec%9c%bc%eb%a1%9c-%ec%96%b4%eb%96%bb%ea%b2%8c-%eb%8f%99%ec%9e%91%ed%95%98%eb%8a%94-%ea%b1%b8%ea%b9%8c aria-label=Anchor>#</a></span></h3><p>트랜잭션의 동작 방식을 알아보기 전에 우선 <strong>영속성 컨텍스트</strong>를 알아야 한다. 스프링 공부를 해봤다면 아마 이 개념을 많이 들어봤을 것이다. 간단히 말해서 영속성 컨텍스트는 데이터베이스로부터 데이터를 읽어온 후 이를 객체로 변환하고 메모리에 유지하며 관리하는 역할을 하는 것이라고 할 수 있다. 멀리 저장되어 있는 정보를 가까이 가져와 조금 더 빠르고 쉽게 관리하며 사용하는 것이라고 간단히 생각해 볼 수 있겠다.</p><p>스프링 컨테이너에서 트랜잭션의 범위는 영속성 컨텍스트의 생존 범위와 같다. 조금 더 풀어서 설명하자면, <code>@Transactional</code> 어노테이션이 붙어있는 메소드를 실행할 때 먼저 트랜잭션이 시작되어 영속성 컨텍스트가 생성되고, 해당 메소드가 정상 종료되면 트랜잭션을 커밋하면서 영속성 컨텍스트도 종료된다. 같이 실행되어 생성되었다가 같이 종료되는 것이다. 아래 그림과 예제를 보면 트랜잭션의 범위와 동작 순서를 더 쉽게 이해할 수 있을 것이다.<figure><img class="my-0 rounded-md" srcset="/posts/transaction_lock/image/1_huaf8ca4a96e7f15d22584abd499b2eccb_191051_330x0_resize_box_3.png 330w,
/posts/transaction_lock/image/1_huaf8ca4a96e7f15d22584abd499b2eccb_191051_660x0_resize_box_3.png 660w,
/posts/transaction_lock/image/1_huaf8ca4a96e7f15d22584abd499b2eccb_191051_1024x0_resize_box_3.png 1024w,
/posts/transaction_lock/image/1_huaf8ca4a96e7f15d22584abd499b2eccb_191051_1320x0_resize_box_3.png 2x" src=/posts/transaction_lock/image/1_huaf8ca4a96e7f15d22584abd499b2eccb_191051_660x0_resize_box_3.png alt="scope of transaction"><figcaption>Illustration of the scope of transaction</figcaption></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequiredArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>HelloService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>HelloRepository</span><span class=w> </span><span class=n>memberRepository</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 1. 트랜잭션 시작 -&gt; 영속성 컨텍스트 생성</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@Transactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>hello</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// 2. member는 영속 상태</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>Member</span><span class=w> </span><span class=n>member</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>memberRepository</span><span class=p>.</span><span class=na>findMember</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=n>member</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// 3. 트랜잭션 종료 -&gt; 영속성 컨텍스트 종료</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Repository</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequiredArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>HelloRepository</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>EntityManager</span><span class=w> </span><span class=n>em</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=n>Member</span><span class=w> </span><span class=nf>findMember</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>find</span><span class=p>(</span><span class=n>Member</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=s>&#34;id1&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 영속성 컨텍스트 접근 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>예제를 보며 차근차근 과정을 따라가 보자.</p><ol><li>어떤 Controller에서 HelloService의 hello() 메소드를 호출하면 트랜잭션이 먼저 실행된다.</li><li>memberRepository로 조회한 member 엔티티는 트랜잭션 범위 안에 속해 있으며, 영속성 컨텍스트에 의해 관리된다.</li><li>해당 메소드가 정상적으로 종료되면 트랜잭션도 커밋하고 종료하게 되는데,</li><li>이때 JPA는 먼저 영속성 컨텍스트를 플러시 해서 데이터베이스에 변경 사항을 반영한 후, 데이터베이스 트랜잭션을 커밋한다.</li><li>만약 예외가 발생했다면 트랜잭션을 롤백하고 종료하고, 이때는 플러시를 호출하지 않는다.</li></ol><p>이와 같은 방식으로 작동하는 트랜잭션이 가지는 한 가지 특징이 있다.</p><blockquote><p>트랜잭션이 같으면 같은 영속성 컨텍스트를 사용하고, 트랜잭션이 다르면 다른 영속성 컨텍스트를 사용한다.</p></blockquote><p>당연한 얘기를 하고 있는 것 같지만 꽤 중요한 특징이라고 할 수 있다. 스프링 컨테이너는 여러 스레드에서 동시에 요청이 오면 각 스레드마다 다른 트랜잭션을 할당한다. 따라서 같은 엔티티 매니저를 사용하고 있다고 해도 트랜잭션이 다르면 (스레드가 다르면) 다른 영속성 컨텍스트를 사용하게 된다. 그래서 멀티스레드 환경에서도 안전하게 동작할 수 있다. 스프링 컨테이너는 이와 같이 복잡한 멀티 스레드 상황을 알아서 처리해 주기 때문에, 개발자들은 싱글 스레드 환경처럼 생각하고 단순하게 개발할 수 있게 된다.<figure><img class="my-0 rounded-md" srcset="/posts/transaction_lock/image/2_hu4d4d164bfadc10a5a862490272296e39_496052_330x0_resize_box_3.png 330w,
/posts/transaction_lock/image/2_hu4d4d164bfadc10a5a862490272296e39_496052_660x0_resize_box_3.png 660w,
/posts/transaction_lock/image/2_hu4d4d164bfadc10a5a862490272296e39_496052_1024x0_resize_box_3.png 1024w,
/posts/transaction_lock/image/2_hu4d4d164bfadc10a5a862490272296e39_496052_1320x0_resize_box_3.png 2x" src=/posts/transaction_lock/image/2_hu4d4d164bfadc10a5a862490272296e39_496052_660x0_resize_box_3.png alt="multi-thread condition"><figcaption>Illustration of the multi-thread condition</figcaption></figure></p></br><h3 class="relative group">1.2. ACID 특성<div id=12-acid-특성 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#12-acid-%ed%8a%b9%ec%84%b1 aria-label=Anchor>#</a></span></h3><p>트랜잭션의 개념을 설명할 때 거의 빠지지 않고 등장하는 중요한 속성이다. ACID는 원자성<sup>Atomicity</sup>, 일관성<sup>Consistency</sup>, 격리성<sup>Isolation</sup>, 지속성<sup>Durability</sup>을 의미하며 데이터베이스 트랜잭션의 안전성을 위해 보장하기 위해 꼭 지켜져야 하는 성질이다. 이 글에서 다루고 싶은 내용은 격리성<sup>Isolation</sup>이기 때문에 다른 특성들은 가볍게 정리하고 넘어가려고 한다.</p><ul><li>원자성</br>: All or Nothing. 트랜잭션 내에서 실행한 작업들은 부분적으로 실행될 수 없고, 모두 성공하거나 모두 실패해야 한다.</li><li>일관성</br>: 트랜잭션이 완료되었을 때 항상 일관성 있는 데이터베이스 상태를 유지해야 한다. 데이터베이스에서 정한 무결성 제약 조건들을 항상 지켜야 한다.</li><li>격리성</br>: 동시에 트랜잭션이 실행되었을 때, 서로에게 영향을 주지 않도록 격리해야 한다.</li><li>지속성</br>: 성공적으로 끝난 트랜잭션의 결과가 항상 기록되어야 한다.</li></ul><p>트랜잭션은 다양한 방법들(롤백 세그먼트, 트리거 등)을 이용해서 원자성, 일관성, 지속성을 보장한다. 그 구체적인 방법들은 다음에 자세히 다뤄보기로 하고 우선 격리성에 집중해 보자.</p><p>트랜잭션의 격리성을 완벽하게 보장하기 위해서는 각각의 트랜잭션을 하나씩 차례로 실행하는 방법이 있는데, 이 경우에는 동시성 처리 성능이 매우 떨어지게 된다. 반대로 동시성 처리 성능을 높이려고 하면 데이터베이스 정보를 다룰 때 서로에게 영향을 끼쳐 여러 문제가 발생할 수 있다는 위험이 있다. 따라서 적용하고자 하는 비즈니스 로직에 따라 격리 수준을 다르게 설정하여 적용해 주어야 하고, 발생할 수 있는 문제들을 확실히 인지하여 알맞게 대응해야 한다.</p><p>트랜잭션의 격리 수준<sup>isolation level</sup>은 ANSI 표준에 따라 다음과 같이 4단계로 나누어 정의된다. 각 수준에 따라 발생할 수 있는 문제점들과 함께 정리하여, 어떤 상황에서 어떤 수준이 적합할지를 직접 느껴보면 좋을 것 같다.</p><table><thead><tr><th style=text-align:center>격리 수준</th><th style=text-align:center>Dirty Read</th><th style=text-align:center>Non-Repeatable Read</th><th style=text-align:center>Phantom Read</th></tr></thead><tbody><tr><td style=text-align:center>Read Uncommitted</td><td style=text-align:center>O</td><td style=text-align:center>O</td><td style=text-align:center>O</td></tr><tr><td style=text-align:center>Read Committed</td><td style=text-align:center></td><td style=text-align:center>O</td><td style=text-align:center>O</td></tr><tr><td style=text-align:center>Repeatable Read</td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center>O</td></tr><tr><td style=text-align:center>Serializable</td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center></td></tr></tbody></table><p>위 표의 순서대로 <code>Read Uncommitted</code>의 격리 수준이 가장 낮고 <code>Serializable</code>이 가장 높다. 하나씩 자세히 살펴보자.</p><ul><li><p><strong>Read Uncommitted</strong></br>영어 번역 그대로, 커밋하지 않은 데이터를 읽을 수 있다는 것이다. 즉 어떤 트랜잭션에서 데이터를 수정했고 아직 커밋이 완료되지 않은 상태지만, 다른 트랜잭션에서 수정된 데이터를 조회할 수 있다는 것이다.<figure><img class="my-0 rounded-md" srcset="/posts/transaction_lock/image/3_hu4ec750d974fe565bd846cb2a826c6a47_362649_330x0_resize_box_3.png 330w,
/posts/transaction_lock/image/3_hu4ec750d974fe565bd846cb2a826c6a47_362649_660x0_resize_box_3.png 660w,
/posts/transaction_lock/image/3_hu4ec750d974fe565bd846cb2a826c6a47_362649_1024x0_resize_box_3.png 1024w,
/posts/transaction_lock/image/3_hu4ec750d974fe565bd846cb2a826c6a47_362649_1320x0_resize_box_3.png 2x" src=/posts/transaction_lock/image/3_hu4ec750d974fe565bd846cb2a826c6a47_362649_660x0_resize_box_3.png alt="dirty read"></figure>위 예에서와 같이 트랜잭션 2에서 y 값을 수정한 후 아직 커밋하지 않았음에도 트랜잭션 1에서 수정 중인 데이터를 조회할 수 있다. 이를 Dirty Read라고 하는데, 트랜잭션 2에서 롤백하는 상황이 생기면 y 값은 1로 다시 돌아오는 반면, x 값은 트랜잭션 1에서 이미 바뀐 y의 값으로 연산이 진행되기 때문에 2 대신 6으로 처리된다. 따라서 이 경우 데이터 정합성에 심각한 문제가 발생할 수 있다.</p></li><li><p><strong>Read Committed</strong></br>커밋한 데이터만을 읽을 수 있다. 따라서 위와 같은 Dirty Read 문제는 발생하지 않는다. y 값이 중간에 변경되어도 커밋이 완료되지 않았다면 다른 트랜잭션에서 조회되지 않기 때문이다.<figure><img class="my-0 rounded-md" srcset="/posts/transaction_lock/image/4_hu755b51124cc9b7e9a0c49d5ddec5e67c_352785_330x0_resize_box_3.png 330w,
/posts/transaction_lock/image/4_hu755b51124cc9b7e9a0c49d5ddec5e67c_352785_660x0_resize_box_3.png 660w,
/posts/transaction_lock/image/4_hu755b51124cc9b7e9a0c49d5ddec5e67c_352785_1024x0_resize_box_3.png 1024w,
/posts/transaction_lock/image/4_hu755b51124cc9b7e9a0c49d5ddec5e67c_352785_1320x0_resize_box_3.png 2x" src=/posts/transaction_lock/image/4_hu755b51124cc9b7e9a0c49d5ddec5e67c_352785_660x0_resize_box_3.png alt="non-repeatable read"></figure>대신 Non-Repeatable Read 문제가 발생한다. 위 그림에서와 같이 트랜잭션 1에서는 x를 두 번 읽는 작업을 하고, 트랜잭션 2에서는 x 값을 수정하는 작업이 진행되는 상황을 떠올려보자. 만약 트랜잭션 1에서 x 읽기 한 번을 수행한 후에 트랜잭션 2의 수정 작업이 모두 끝나 커밋까지 완료했다면, 두 번째 x 값을 읽을 때는 이전 결과와 다른 값이 조회될 것이다. 이처럼 한 트랜잭션 안에서 읽었음에도 값이 달라지는 경우를 Non-Repeatable Read라 한다.</p></li><li><p><strong>Repeatable Read</strong></br>트랜잭션 안에서 한 번 조회한 데이터를 반복해서 조회하면 같은 데이터가 읽힌다. 하지만 추가적으로 이전에 없었던 데이터가 새로 생기는 현상이 발생할 수는 있다. 이를 Phantom Read 문제라 한다.<figure><img class="my-0 rounded-md" srcset="/posts/transaction_lock/image/5_hu7d173fb8cc21305cabf8a94b78952a38_454165_330x0_resize_box_3.png 330w,
/posts/transaction_lock/image/5_hu7d173fb8cc21305cabf8a94b78952a38_454165_660x0_resize_box_3.png 660w,
/posts/transaction_lock/image/5_hu7d173fb8cc21305cabf8a94b78952a38_454165_1024x0_resize_box_3.png 1024w,
/posts/transaction_lock/image/5_hu7d173fb8cc21305cabf8a94b78952a38_454165_1320x0_resize_box_3.png 2x" src=/posts/transaction_lock/image/5_hu7d173fb8cc21305cabf8a94b78952a38_454165_660x0_resize_box_3.png alt="phantom read"></figure>위의 예에서 트랜잭션 1은 val 값이 10인 데이터를 두 번 읽는 작업을 수행하고 트랜잭션 2에서는 m2 객체의 val 값을 10으로 바꾸는 작업을 한다. 트랜잭션 1에서 한 번 읽기 작업이 수행되면 m1 객체가 조회된다. 하지만 두 번째 읽기 작업이 시작되기 전에 트랜잭션 2에서 커밋이 완료되면, m1과 m2 모두 val 값이 10이 되기 때문에 m2 객체 하나가 추가되어 첫 번째 조회 결과 집합과 달라지게 된다.</p></li><li><p><strong>Serializable</strong></br>트랜잭션을 그냥 순차적으로 진행시킨다. 가장 엄격한 격리 수준을 가지며 동시 처리 성능이 매우 떨어진다.</p></li></ul><p>글을 읽다 보면 느낄 수 있듯이 트랜잭션 격리 작업은 데이터베이스 처리의 가장 기본이 되는 것 중 하나이다. 따라서 각 오픈소스 데이터베이스(MySQL, PostgreSQL, MariaDB 등)에서는 기본으로 사용하고 있는 격리 수준을 명시하고 있고, 사용자가 직접 지정할 수도 있도록 지원하고 있다.
그렇다면 스프링 프레임워크에서는 어떤 방식으로 설정이 되어 있는지 궁금해져 <code>Transactional</code> 어노테이션을 살펴보았다. <code>Transactional</code> 안에 <code>Isolation</code>은 기본 <code>DEFAULT</code>로 설정되어 있고, 초록색 주석 부분을 읽어보면 이 <code>DEFAULT</code>는 underlying datastore, 즉, 사용하고 있는 데이터베이스 격리 수준을 그대로 따르도록 설정되어 있음을 확인할 수 있었다.<figure><img class="my-0 rounded-md" srcset="/posts/transaction_lock/image/6_hu1b5e88791effa27bf540964da6890112_218449_330x0_resize_box_3.png 330w,
/posts/transaction_lock/image/6_hu1b5e88791effa27bf540964da6890112_218449_660x0_resize_box_3.png 660w,
/posts/transaction_lock/image/6_hu1b5e88791effa27bf540964da6890112_218449_1024x0_resize_box_3.png 1024w,
/posts/transaction_lock/image/6_hu1b5e88791effa27bf540964da6890112_218449_1320x0_resize_box_3.png 2x" src=/posts/transaction_lock/image/6_hu1b5e88791effa27bf540964da6890112_218449_660x0_resize_box_3.png alt=transactional><figcaption>Code of @Transactional</figcaption></figure><figure><img class="my-0 rounded-md" srcset="/posts/transaction_lock/image/7_hubb3c0581bc1c2d9d441a9879ada3974d_62311_330x0_resize_box_3.png 330w,
/posts/transaction_lock/image/7_hubb3c0581bc1c2d9d441a9879ada3974d_62311_660x0_resize_box_3.png 660w,
/posts/transaction_lock/image/7_hubb3c0581bc1c2d9d441a9879ada3974d_62311_1024x0_resize_box_3.png 1024w,
/posts/transaction_lock/image/7_hubb3c0581bc1c2d9d441a9879ada3974d_62311_1320x0_resize_box_3.png 2x" src=/posts/transaction_lock/image/7_hubb3c0581bc1c2d9d441a9879ada3974d_62311_660x0_resize_box_3.png alt=isolation><figcaption>Code of Isolation</figcaption></figure></p><p>대부분의 애플리케이션에서는 동시성 처리가 중요하기 때문에 <code>Read Committed</code>를 사용하고 <code>Repeatable Read</code>도 많이 선택한다. 하지만 더 높은 수준의 격리가 필요한 비즈니스 로직에는 데이터베이스 트랜잭션이 제공하는 락(Lock) 기능을 추가로 사용하게 되는데, 이어서 자세히 살펴보려고 한다.</p></br><h2 class="relative group">2. 더 높은 격리 수준이 필요하다면, 락(Lock)을 사용하자<div id=2-더-높은-격리-수준이-필요하다면-락lock을-사용하자 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-%eb%8d%94-%eb%86%92%ec%9d%80-%ea%b2%a9%eb%a6%ac-%ec%88%98%ec%a4%80%ec%9d%b4-%ed%95%84%ec%9a%94%ed%95%98%eb%8b%a4%eb%a9%b4-%eb%9d%bdlock%ec%9d%84-%ec%82%ac%ec%9a%a9%ed%95%98%ec%9e%90 aria-label=Anchor>#</a></span></h2><p>앞에서 언급한 트랜잭션 격리 수준이 전부는 아니다. <code>Read Committed</code> 격리 수준을 사용해도 락(Lock)을 이용하면 <code>Repeatable Read(반복 가능한 읽기)</code>가 가능하게 만들 수 있다. 구체적으로 살펴보면, 우선 락의 종류에는 낙관적 락(Optimistic Lock)과 비관적 락(Pessimistic Lock)이 있다.</p></br><h3 class="relative group">2.1. 낙관적 락(Optimistic Lock)<div id=21-낙관적-락optimistic-lock class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#21-%eb%82%99%ea%b4%80%ec%a0%81-%eb%9d%bdoptimistic-lock aria-label=Anchor>#</a></span></h3><p><strong>낙관적 락</strong>은 이름을 통해서도 알 수 있듯이, 대부분의 트랜잭션에서 충돌이 발생하지 않을 것이라고 낙관적으로 가정한 상태에서 충돌에 대비하는 방식이다. 충돌이 발생하지 않을 것이라고 가정했기 때문에 일단 작업을 진행했다가 커밋할 때 충돌이 일어났는지를 확인하게 된다. 낙관적 락은 JPA가 제공하는 버전 관리 기능을 사용하여 동작하고 <code>@Version</code> 어노테이션을 통해 간단히 구현할 수 있다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Entity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Board</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@Id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>title</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@Version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>version</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>버전 관리 기능은 위의 예처럼 락을 적용하고자 하는 엔티티에 버전용 필드를 하나 만들고 위에 <code>@Version</code> 어노테이션만 붙여주면 된다. 해당 필드의 타입은 <code>Integer</code> 외에도 <code>Long</code>, <code>Short</code>, <code>Timestamp</code>가 가능하다.
버전을 이용해서 충돌을 인지하는 방법은 매우 단순하다. 우선 엔티티의 상태가 변경될 때마다 버전이 자동으로 하나씩 증가한다. 그리고 엔티티를 수정할 때는 처음 조회 시점의 버전과 커밋할 때 마지막 시점의 버전을 비교하여 그 값이 다르면 예외가 발생한다. 예를 들어 만약 트랜잭션 1에서 Board 엔티티를 수정하는 도중, 동시에 트랜잭션 2에서 같은 엔티티를 수정하고 커밋하여 버전이 증가해 버렸다면, 트랜잭션 1의 마지막 커밋 시점에서 바뀐 버전 정보가 읽히기 때문에 예외가 발생하게 된다. 아래 예에서는 트랜잭션 2에서 title 값이 변하면서 버전이 2로 증가했기 때문에, Transaction 1에서 예외가 발생하게 된다. 따라서 낙관적 락에서와 같이 버전 정보를 사용하게 되면 최초의 커밋만을 인정하는 방식으로 작동한다.<figure><img class="my-0 rounded-md" srcset="/posts/transaction_lock/image/8_hu1f29ea8f2ca25ad3de8902fd55d0c1dd_331806_330x0_resize_box_3.png 330w,
/posts/transaction_lock/image/8_hu1f29ea8f2ca25ad3de8902fd55d0c1dd_331806_660x0_resize_box_3.png 660w,
/posts/transaction_lock/image/8_hu1f29ea8f2ca25ad3de8902fd55d0c1dd_331806_1024x0_resize_box_3.png 1024w,
/posts/transaction_lock/image/8_hu1f29ea8f2ca25ad3de8902fd55d0c1dd_331806_1320x0_resize_box_3.png 2x" src=/posts/transaction_lock/image/8_hu1f29ea8f2ca25ad3de8902fd55d0c1dd_331806_660x0_resize_box_3.png alt="optimistic lock"></figure></p><p>조금 더 구체적으로 보면, 엔티티 수정 후 트랜잭션을 커밋하면 영속성 컨텍스트를 플러시 하면서 UPDATE 쿼리가 실행된다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>BOARD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>SET</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>TITLE</span><span class=o>=</span><span class=s1>&#39;B&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>VERSION</span><span class=o>=</span><span class=mi>2</span><span class=w> </span><span class=p>(</span><span class=err>버전</span><span class=w> </span><span class=err>증가하기</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>ID</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>AND</span><span class=w> </span><span class=n>VERSION</span><span class=o>=</span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></div><p>UPDATE 쿼리는 다음과 같이 구성되는데 WHERE 문을 통해 기존 버전과 값을 비교하고 값이 같으면 버전을 하나 증가시키고 아니면 예외를 발생시킨다.</p><p>기본적으로 <code>@Version</code>만 적용했을 때는 엔티티의 값에 수정이 생겼을 때 버전이 증가한다. 만약 엔티티를 조회만 해도 버전을 체크하고 싶다면, <code>OPTIMISTIC</code> 옵션을 추가해 주면 된다. 이 방식을 사용하면 <code>Dirty Read</code>와 <code>Non-Repeatable Read</code>를 방지할 수 있다는 이점이 있다. 또한, 연관관계 필드의 경우 외래 키를 관리하는 연관관계의 주인 필드를 수정할 때만 버전이 증가한다. 만약 강제로 버전 정보를 증가하여 원하는 대로 관리하고 싶다면 <code>OPTIMISTIC_FORCE_INCREMENT</code> 옵션을 사용해 주면 된다.</p></br><h3 class="relative group">2.2. 비관적 락(Pessimistic Lock)<div id=22-비관적-락pessimistic-lock class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#22-%eb%b9%84%ea%b4%80%ec%a0%81-%eb%9d%bdpessimistic-lock aria-label=Anchor>#</a></span></h3><p><strong>비관적 락</strong>은 트랜잭션의 충돌이 발생할 것이라고 비관적으로 가정하여 우선 락을 걸고 보는 방법이다. JPA의 버전 관리 기능을 사용하는 낙관적 락과 달리 데이터베이스가 제공하는 락 메커니즘을 사용하며, 데이터 수정 즉시 충돌을 감지하게 된다. 대표적으로 SQL 쿼리의 <code>select for update</code> 구문을 사용하며 시작한다.</p><p>비관적 락에는 <code>PESSIMISTIC_WRITE</code>, <code>PESSIMISTIC_READ</code> 옵션이 있는데, 일반적으로는 <code>PESSIMISTIC_WRITE</code> 모드를 사용한다.</p><ul><li><strong>PESSIMISTIC_WRITE</strong></br>데이터베이스에 쓰기 락을 거는 옵션이다. 쉽게 생각하면, &lsquo;나 데이터 <strong>쓰기</strong> 작업하려고 락(Lock) 걸거야!&lsquo;라고 선언하는 것이라 생각하면 된다. 따라서 트랜잭션 1에서 쓰기 락을 가져갈 경우, 트랜잭션 2에서는 해당 데이터가 변경될 수 있기 때문에 락이 풀릴 때까지 읽기, 쓰기 둘 다 불가능하다.</li><li><strong>PESSIMISTIC_READ</strong></br>데이터베이스에 읽기 락을 거는 옵션이다. 쓰기 락과는 달리 &lsquo;나 데이터 <strong>읽기</strong> 작업하려고 락(Lock) 걸 거야!&lsquo;로 이해하면 쉽다. 따라서 트랜잭션 1에서 읽기 락을 가져갈 경우, 트랜잭션 2에서 해당 데이터를 읽는 것은 데이터의 일관성에 아무런 문제가 없기 때문에 가능하다. 하지만 데이터를 쓰는 것은 값에 변화가 생겨 트랜잭션 1과 달라질 수 있으므로 불가능하다.</li></ul></br><p>길고 긴 여정을 통해 트랜잭션과 락에 대한 기본 지식을 익히는 시간을 가졌다. 중간중간 생략하거나 넘어간 설명들이 있었지만, 이 정도면 주요한 개념들을 이해하는 데 큰 도움이 되었을 것이라 생각한다.
이 여정의 결론에서 도달한 핵심은 &lsquo;데이터베이스 관리에서 동시성과 무결성 사이의 적절한 균형이 중요하다&rsquo;는 것이다. 그리고 이 균형을 설정하고 유지하기 위해서는 트랜잭션과 락을 제대로 이해하고 적절하게 활용할 줄 알아야 한다.
글을 써가며 최대한 예를 들어 설명을 자세히 적으려고 노력했다. 이를 통해 자신의 프로젝트 상황에 따라 잘 판단하여 현명하게 데이터베이스를 관리할 수 있기를 바란다.</p></div></div><script>var oid="views_posts/transaction_lock/index.md",oid_likes="likes_posts/transaction_lock/index.md"</script><script type=text/javascript src=/js/page.min.5b1bad196a6075a1e11bae1dc95f24f67b610948a00525e347566c5a62338ea78f1c7224ab9a53873dcdb2a1a7d7d391b8a8ef45561297f68806c01315b0c4f6.js integrity="sha512-WxutGWpgdaHhG64dyV8k9nthCUigBSXjR1ZsWmIzjqePHHIkq5pThz3NsqGn19ORuKjvRVYSl/aIBsATFbDE9g=="></script></section><footer class="pt-8 max-w-prose print:hidden"></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2024
Hi, I&rsquo;m Sumin Lee!</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.62060bb247f4de2b6dde45903668fefb68d792f365587605177b1227c0cf43588701edaca0cb40e2c8e2789bd5ce67c1d2a215b9fb258c3496a7cd25e7cb5fdf.js integrity="sha512-YgYLskf03itt3kWQNmj++2jXkvNlWHYFF3sSJ8DPQ1iHAe2soMtA4sjieJvVzmfB0qIVufsljDSWp80l58tf3w=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://smmin21.github.io/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>